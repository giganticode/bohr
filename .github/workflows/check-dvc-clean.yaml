name: check-dvc-clean
on:
  push:
    branches: [ master ]
jobs:
  check-dvc-clean:
    defaults:
      run:
        shell: bash -lieo pipefail {0}
        working-directory: /usr/src/bohr
    runs-on: self-hosted
    container: giganticode/bohr-cml-base:latest
    steps:
      - uses: actions/checkout@v2
      - name: check-dvc-clean
        env:
          DVC_IRONSPEED_PASSWORD: ${{ secrets.DVC_IRONSPEED_PASSWORD }}
          PYTHONPATH: /usr/src/bohr/
        run: |
          pip install "dvc[ssh]==$(cat DVC_VERSION)"
          dvc --version
          dvc remote modify --local ironspeed user hbabii
          dvc remote modify --local ironspeed password $DVC_IRONSPEED_PASSWORD
          dvc pull -r ironspeed
          dvc repro preprocess_bugginess_train
          dvc status
          dvc status -q
