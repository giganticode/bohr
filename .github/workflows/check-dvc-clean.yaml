name: check-dvc-clean
on:
  push:
    branches: [ master ]
jobs:
  check-dvc-clean:
    defaults:
      run:
        shell: bash -lieo pipefail {0}
        working-directory: /usr/src/bohr
    runs-on: self-hosted
    container: giganticode/bohr-cml-base:latest
    env:
      DVC_IRONSPEED_USERNAME: ${{ secrets.DVC_IRONSPEED_USERNAME }}
      DVC_IRONSPEED_PASSWORD: ${{ secrets.DVC_IRONSPEED_PASSWORD }}
      PYTHONPATH: /usr/src/bohr/
    steps:
      - uses: actions/checkout@v2
      - name: install-dvc
        run: |
          pip install "dvc[ssh]==$(cat DVC_VERSION)"
          dvc --version
          dvc remote modify --local ironspeed user $DVC_IRONSPEED_USERNAME
          dvc remote modify --local ironspeed password $DVC_IRONSPEED_PASSWORD
      - name: reproduce-and-check-status
        run: |
          dvc pull -r ironspeed
          dvc repro preprocess_bugginess_train
          dvc status
          dvc status -q
